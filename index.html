<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Recuento Seguros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#4a7c2b" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --verde-claro: #a6d96a;
      --verde-oscuro: #4a7c2b;
      --naranja-claro: #ffd08a;
      --naranja-oscuro: #d98b00;
      --amarillo-claro: #ffe18a;
      --amarillo-oscuro: #cfa12a;
      --rojo: #e4573d;
      --gris-fondo: #f5f5f5;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      background: var(--gris-fondo);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 24px;
      padding: 16px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }

    .title {
      text-align: center;
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 18px;
      border: 3px solid black;
      border-radius: 999px;
      padding: 10px;
    }

    /* ---- BOTÓN PRINCIPAL PRESENTADO ---- */
    .presentado-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 24px;
    }

    .presentado-wrapper {
      display: flex;
      align-items: center;
    }

    .minus-btn {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--amarillo-claro), var(--amarillo-oscuro));
      border: 4px solid var(--verde-oscuro);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
      user-select: none;
      margin-right: -18px;
      z-index: 1;
      transition: transform 0.1s ease;
    }

    .minus-btn:active { transform: scale(0.95); }

    .presentado-btn {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #c8f28e, var(--verde-claro));
      border: 5px solid var(--verde-oscuro);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      cursor: pointer;
      box-shadow: 0 5px 12px rgba(0,0,0,0.18);
      transition: transform 0.1s ease;
    }

    .presentado-btn:active { transform: scale(0.95); }

    .presentado-btn .count {
      font-size: 2.4rem;
      font-weight: 700;
    }

    .presentado-btn .label {
      font-size: 1.1rem;
      margin-top: 4px;
    }

    /* ---- RESTO DE BOTONES ---- */
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .button-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .button-row {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .small-minus {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--amarillo-claro), var(--amarillo-oscuro));
      border: 4px solid var(--verde-oscuro);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      margin-right: -16px;
      z-index: 1;
      box-shadow: 0 3px 8px rgba(0,0,0,0.18);
      transition: transform 0.1s ease;
    }

    .small-minus:active { transform: scale(0.95); }

    .circle-btn {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--naranja-claro), var(--naranja-oscuro));
      border: 4px solid var(--naranja-oscuro);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.1s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.16);
    }

    .circle-btn:active { transform: scale(0.95); }

    .circle-btn .count {
      font-size: 2rem;
      font-weight: 600;
    }

    .label { font-size: 0.85rem; text-align: center; }

    /* ---- BOTÓN BORRAR ---- */
    .actions-row {
      display: flex;
      justify-content: center;
      margin-bottom: 24px;
    }

    .clear-btn {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
      background: radial-gradient(circle at 30% 30%, #ff8b6b, var(--rojo));
      border: 4px solid #a12a1a;
      color: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: transform 0.1s ease;
    }

    .clear-btn:active { transform: scale(0.95); }

    /* ---- TOTALES ---- */
    .totals {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 18px;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      font-size: 1rem;
    }

    .total-box {
      min-width: 120px;
      padding: 8px;
      font-size: 1.2rem;
      text-align: center;
      font-weight: 700;
      border-radius: 999px;
      border: 3px solid black;
    }

    #objetivo-box.ok { color: #0a7c0a; border-color: #0a7c0a; }
    #objetivo-box.bad { color: #b00020; border-color: #b00020; }

    /* ---- RESUMEN DIARIO ---- */
    .daily-section {
      margin-top: 8px;
    }

    .daily-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .month-label {
      font-weight: 600;
    }

    .export-btn {
      border-radius: 999px;
      border: 1px solid #222;
      padding: 4px 10px;
      font-size: 0.85rem;
      cursor: pointer;
      background: #f0f0f0;
    }

    .daily-table-wrapper {
      max-height: 220px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #ddd;
    }

    table.daily-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .daily-table thead {
      position: sticky;
      top: 0;
      background: #f0f0f0;
      z-index: 1;
    }

    .daily-table th,
    .daily-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      text-align: center;
      white-space: nowrap;
    }

    .daily-table th:first-child,
    .daily-table td:first-child {
      text-align: left;
    }

    .daily-table tr:nth-child(even) td {
      background: #fafafa;
    }

    @media (max-width: 420px) {
      .daily-table-wrapper { max-height: 180px; }
      .daily-table th,
      .daily-table td {
        padding: 3px 4px;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="title">RECUENTO SEGUROS</div>

    <!-- BOTÓN PRESENTADO CON "-" -->
    <div class="presentado-container">
      <div class="presentado-wrapper">
        <div class="minus-btn" id="minus-presentado">−</div>
        <div class="presentado-btn" id="btn-presentado">
          <span class="count" id="count-presentado">0</span>
          <span class="label">Presentado</span>
        </div>
      </div>
    </div>

    <!-- RESTO DE BOTONES -->
    <div class="grid" id="buttons-grid"></div>

    <!-- BORRAR TODO -->
    <div class="actions-row">
      <button class="clear-btn" id="clear-btn">
        <div>Borrar</div>
        <div>todo</div>
      </button>
    </div>

    <!-- TOTALES -->
    <div class="totals">
      <div class="total-row">
        <div>Total unidades</div>
        <div class="total-box" id="total-unidades-box">0</div>
      </div>

      <div class="total-row">
        <div>Presentados</div>
        <div class="total-box" id="presentados-box">0</div>
      </div>

      <div class="total-row">
        <div>Objetivo</div>
        <div class="total-box" id="objetivo-box">+0</div>
      </div>
    </div>

    <!-- RESUMEN DIARIO -->
    <div class="daily-section">
      <div class="daily-header">
        <span class="month-label" id="month-label"></span>
        <button class="export-btn" id="export-btn">Exportar</button>
      </div>
      <div class="daily-table-wrapper">
        <table class="daily-table">
          <thead>
            <tr>
              <th>Día</th>
              <th>Presentado</th>
              <th>No presentado</th>
              <th>Reserva</th>
              <th>Total unidades</th>
              <th>Presentados</th>
              <th>Objetivo</th>
            </tr>
          </thead>
          <tbody id="daily-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIGURACIÓN ---------- */

// Botones "normales" (naranja)
const buttons = [
  { key: "noPresentado", label: "No presentado" },
  { key: "reserva",      label: "Reserva" },
  { key: "noLoQuiere",   label: "No lo quiere" },
  { key: "ticket",       label: "Ticket" },
  { key: "extranjero",   label: "Extranjero" },
  { key: "rescicion",    label: "Rescisión" },
  { key: "abono",        label: "Abono" },
  { key: "factura",      label: "Factura" },
  { key: "regalo",       label: "Regalo" }
];

const UNITS_KEYS     = ["presentado", ...buttons.map(b => b.key)];
const PRESENTED_KEYS = ["presentado"];

const STORAGE_KEY = "segurosCounter_v4";

/* Estructura del estado:
   {
     counts: {presentado: n, ...}    // acumulado del mes
     monthId: "YYYY-MM",
     daily: {
       "YYYY-MM-DD": { counts: {presentado: n,...} }
     }
   }
*/
let state = { counts: {}, monthId: "", daily: {} };

/* ---------- FECHAS ---------- */

function todayDate() {
  const d = new Date();
  return d;
}

function formatDateKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function formatMonthId(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  return `${y}-${m}`;
}

function getCurrentMonthDays() {
  const d = todayDate();
  const year = d.getFullYear();
  const month = d.getMonth();
  const todayDay = d.getDate();
  return { year, month, todayDay };
}

/* ---------- ESTADO ---------- */

function emptyCounts() {
  const obj = { presentado: 0 };
  buttons.forEach(b => { obj[b.key] = 0; });
  return obj;
}

function initStateForCurrentMonth() {
  const now = todayDate();
  state = {
    counts: emptyCounts(),
    monthId: formatMonthId(now),
    daily: {}
  };
}

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  const now = todayDate();
  const currentMonthId = formatMonthId(now);

  if (!raw) {
    initStateForCurrentMonth();
    return;
  }

  try {
    const parsed = JSON.parse(raw);
    if (!parsed.monthId || parsed.monthId !== currentMonthId) {
      // Mes nuevo -> reseteamos todo
      initStateForCurrentMonth();
      return;
    }
    // Mes actual: recuperamos asegurando claves
    state.monthId = parsed.monthId;
    state.counts  = { ...emptyCounts(), ...(parsed.counts || {}) };
    state.daily   = parsed.daily || {};
  } catch {
    initStateForCurrentMonth();
  }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function ensureTodayDaily() {
  const key = formatDateKey(todayDate());
  if (!state.daily[key]) {
    state.daily[key] = { counts: emptyCounts() };
  }
  return key;
}

/* ---------- CÁLCULOS ---------- */

function computeTotalsFromCounts(countsObj) {
  let totalUnits = 0;
  let presented = 0;

  UNITS_KEYS.forEach(k => {
    totalUnits += countsObj[k] || 0;
  });
  PRESENTED_KEYS.forEach(k => {
    presented += countsObj[k] || 0;
  });

  const objetivo = 2 * presented - totalUnits;
  return { totalUnits, presented, objetivo };
}

function computeMonthlyTotals() {
  return computeTotalsFromCounts(state.counts);
}

/* ---------- RENDER BOTONES Y TOTALES ---------- */

function renderButtons() {
  const grid = document.getElementById("buttons-grid");
  grid.innerHTML = "";

  buttons.forEach(btn => {
    const card = document.createElement("div");
    card.className = "button-card";

    const row = document.createElement("div");
    row.className = "button-row";

    const minus = document.createElement("div");
    minus.className = "small-minus";
    minus.textContent = "−";
    minus.onclick = () => decrement(btn.key);

    const circle = document.createElement("div");
    circle.className = "circle-btn";
    circle.dataset.key = btn.key;
    const span = document.createElement("span");
    span.className = "count";
    span.textContent = state.counts[btn.key] || 0;
    circle.appendChild(span);
    circle.onclick = () => increment(btn.key);

    row.appendChild(minus);
    row.appendChild(circle);

    const label = document.createElement("div");
    label.className = "label";
    label.textContent = btn.label;

    card.appendChild(row);
    card.appendChild(label);
    grid.appendChild(card);
  });
}

function renderTotals() {
  const { totalUnits, presented, objetivo } = computeMonthlyTotals();
  document.getElementById("total-unidades-box").textContent = totalUnits;
  document.getElementById("presentados-box").textContent = presented;

  const objBox = document.getElementById("objetivo-box");
  objBox.textContent = (objetivo >= 0 ? "+" : "") + objetivo;
  objBox.classList.toggle("ok", objetivo >= 0);
  objBox.classList.toggle("bad", objetivo < 0);

  document.getElementById("count-presentado").textContent =
    state.counts.presentado || 0;

  buttons.forEach(btn => {
    const el = document.querySelector(
      `.circle-btn[data-key="${btn.key}"] .count`
    );
    if (el) el.textContent = state.counts[btn.key] || 0;
  });
}

/* ---------- RENDER TABLA DIARIA ---------- */

function renderDailyTable() {
  const { year, month, todayDay } = getCurrentMonthDays();
  const tbody = document.getElementById("daily-tbody");
  tbody.innerHTML = "";

  // Etiqueta del mes
  const monthLabel = document.getElementById("month-label");
  const monthName = new Date(year, month, 1).toLocaleString("es-ES", {
    month: "long",
    year: "numeric"
  });
  monthLabel.textContent = `Resumen diario · ${monthName}`;

  for (let day = 1; day <= todayDay; day++) {
    const d = new Date(year, month, day);
    const key = formatDateKey(d);
    const dayCounts = state.daily[key]?.counts || emptyCounts();
    const { totalUnits, presented, objetivo } = computeTotalsFromCounts(dayCounts);

    const tr = document.createElement("tr");

    const tdDia = document.createElement("td");
    tdDia.textContent = day.toString().padStart(2, "0");

    const tdPres   = document.createElement("td");
    const tdNoPres = document.createElement("td");
    const tdRes    = document.createElement("td");

    tdPres.textContent   = dayCounts.presentado   || 0;
    tdNoPres.textContent = dayCounts.noPresentado || 0;
    tdRes.textContent    = dayCounts.reserva      || 0;

    const tdTotal = document.createElement("td");
    const tdPresentados = document.createElement("td");
    const tdObjetivo = document.createElement("td");

    tdTotal.textContent       = totalUnits;
    tdPresentados.textContent = presented;
    tdObjetivo.textContent    = (objetivo >= 0 ? "+" : "") + objetivo;

    tr.appendChild(tdDia);
    tr.appendChild(tdPres);
    tr.appendChild(tdNoPres);
    tr.appendChild(tdRes);
    tr.appendChild(tdTotal);
    tr.appendChild(tdPresentados);
    tr.appendChild(tdObjetivo);

    tbody.appendChild(tr);
  }
}

/* ---------- ACCIONES ---------- */

function increment(key) {
  state.counts[key] = (state.counts[key] || 0) + 1;

  const todayKey = ensureTodayDaily();
  const dayCounts = state.daily[todayKey].counts;
  dayCounts[key] = (dayCounts[key] || 0) + 1;

  saveState();
  renderTotals();
  renderDailyTable();
}

function decrement(key) {
  if (!state.counts[key]) return;

  state.counts[key] = Math.max(0, (state.counts[key] || 0) - 1);

  const todayKey = ensureTodayDaily();
  const dayCounts = state.daily[todayKey].counts;
  dayCounts[key] = Math.max(0, (dayCounts[key] || 0) - 1);

  saveState();
  renderTotals();
  renderDailyTable();
}

function clearAll() {
  if (!confirm("¿Seguro que quieres borrar todos los datos de este mes y empezar de cero?")) return;
  initStateForCurrentMonth();
  saveState();
  renderButtons();
  renderTotals();
  renderDailyTable();
}

/* ---------- EXPORTAR CSV ---------- */

function exportCSV() {
  const { year, month, todayDay } = getCurrentMonthDays();
  const monthName = new Date(year, month, 1).toLocaleString("es-ES", {
    month: "long",
    year: "numeric"
  });

  const header = [
    "Fecha",
    "Presentado",
    "No presentado",
    "Reserva",
    "No lo quiere",
    "Ticket",
    "Extranjero",
    "Rescisión",
    "Abono",
    "Factura",
    "Regalo",
    "Total unidades",
    "Presentados",
    "Objetivo"
  ];

  const rows = [];
  rows.push(header.join(";"));

  for (let day = 1; day <= todayDay; day++) {
    const d = new Date(year, month, day);
    const key = formatDateKey(d);
    const dayCounts = state.daily[key]?.counts || emptyCounts();
    const { totalUnits, presented, objetivo } = computeTotalsFromCounts(dayCounts);

    const fecha = key; // YYYY-MM-DD

    const row = [
      fecha,
      dayCounts.presentado   || 0,
      dayCounts.noPresentado || 0,
      dayCounts.reserva      || 0,
      dayCounts.noLoQuiere   || 0,
      dayCounts.ticket       || 0,
      dayCounts.extranjero   || 0,
      dayCounts.rescicion    || 0,
      dayCounts.abono        || 0,
      dayCounts.factura      || 0,
      dayCounts.regalo       || 0,
      totalUnits,
      presented,
      objetivo
    ];

    rows.push(row.join(";"));
  }

  const csvContent = rows.join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  const fname = `recuento_seguros_${monthName.replace(/\s+/g,"_")}.csv`;
  link.download = fname;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/* ---------- ARRANQUE ---------- */

function main() {
  loadState();
  renderButtons();
  renderTotals();
  renderDailyTable();

  document.getElementById("btn-presentado").onclick = () => increment("presentado");
  document.getElementById("minus-presentado").onclick = () => decrement("presentado");
  document.getElementById("clear-btn").onclick = clearAll;
  document.getElementById("export-btn").onclick = exportCSV;

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js").catch(() => {});
  }
}

main();
</script>

</body>
</html>
